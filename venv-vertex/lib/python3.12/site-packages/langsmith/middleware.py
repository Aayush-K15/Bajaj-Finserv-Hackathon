


class TracingMiddleware:
    

    def __init__(self, app):
        
        from langsmith.run_helpers import tracing_context  

        self._with_headers = tracing_context
        self.app = app

    async def __call__(self, scope: dict, receive, send):
        
        if scope["type"] == "http" and "headers" in scope:
            headers = dict(scope["headers"])
            if b"langsmith-trace" in headers:
                with self._with_headers(parent=headers):
                    await self.app(scope, receive, send)
                return
        await self.app(scope, receive, send)
