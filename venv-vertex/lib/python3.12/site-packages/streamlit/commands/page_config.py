













from __future__ import annotations

import random
from collections.abc import Mapping
from pathlib import Path
from textwrap import dedent
from typing import TYPE_CHECKING, Any, Final, Literal, Union, cast

from typing_extensions import TypeAlias

from streamlit.elements.lib.image_utils import AtomicImage, image_to_url
from streamlit.errors import (
    StreamlitInvalidMenuItemKeyError,
    StreamlitInvalidPageLayoutError,
    StreamlitInvalidSidebarStateError,
    StreamlitInvalidURLError,
)
from streamlit.proto.ForwardMsg_pb2 import ForwardMsg as ForwardProto
from streamlit.proto.PageConfig_pb2 import PageConfig as PageConfigProto
from streamlit.runtime.metrics_util import gather_metrics
from streamlit.runtime.scriptrunner_utils.script_run_context import get_script_run_ctx
from streamlit.string_util import is_emoji, validate_material_icon
from streamlit.url_util import is_url

if TYPE_CHECKING:
    from typing_extensions import TypeGuard

GET_HELP_KEY: Final = "get help"
REPORT_A_BUG_KEY: Final = "report a bug"
ABOUT_KEY: Final = "about"

PageIcon: TypeAlias = Union[AtomicImage, str]
Layout: TypeAlias = Literal["centered", "wide"]
InitialSideBarState: TypeAlias = Literal["auto", "expanded", "collapsed"]
_GetHelp: TypeAlias = Literal["Get help", "Get Help", "get help"]
_ReportABug: TypeAlias = Literal["Report a bug", "report a bug"]
_About: TypeAlias = Literal["About", "about"]
MenuKey: TypeAlias = Literal[_GetHelp, _ReportABug, _About]
MenuItems: TypeAlias = Mapping[MenuKey, Union[str, None]]

RANDOM_EMOJIS: Final = list(
    "ðŸ”¥â„¢ðŸŽ‰ðŸš€ðŸŒŒðŸ’£âœ¨ðŸŒ™ðŸŽ†ðŸŽ‡ðŸ’¥ðŸ¤©ðŸ¤™ðŸŒ›ðŸ¤˜â¬†ðŸ’¡ðŸ¤ªðŸ¥‚âš¡ðŸ’¨ðŸŒ ðŸŽŠðŸ¿ðŸ˜›ðŸ”®ðŸ¤ŸðŸŒƒðŸƒðŸ¾ðŸ’«â–ªðŸŒ´ðŸŽˆðŸŽ¬ðŸŒ€ðŸŽ„ðŸ˜â˜”â›½ðŸ‚ðŸ’ƒðŸ˜ŽðŸ¸ðŸŽ¨ðŸ¥³â˜€ðŸ˜ðŸ…±ðŸŒžðŸ˜»ðŸŒŸðŸ˜œðŸ’¦ðŸ’…ðŸ¦„ðŸ˜‹ðŸ˜‰ðŸ‘»ðŸðŸ¤¤ðŸ‘¯ðŸŒ»â€¼ðŸŒˆðŸ‘ŒðŸŽƒðŸ’›ðŸ˜šðŸ”«ðŸ™ŒðŸ‘½ðŸ¬ðŸŒ…â˜ðŸ·ðŸ‘­â˜•ðŸŒšðŸ’ðŸ‘…ðŸ¥°ðŸœðŸ˜ŒðŸŽ¥ðŸ•ºâ•ðŸ§¡â˜„ðŸ’•ðŸ»âœ…ðŸŒ¸ðŸš¬ðŸ¤“ðŸ¹Â®â˜ºðŸ’ªðŸ˜™â˜˜ðŸ¤ âœŠðŸ¤—ðŸµðŸ¤žðŸ˜‚ðŸ’¯ðŸ˜ðŸ“»ðŸŽ‚ðŸ’—ðŸ’œðŸŒŠâ£ðŸŒðŸ˜˜ðŸ’†ðŸ¤‘ðŸŒ¿ðŸ¦‹ðŸ˜ˆâ›„ðŸš¿ðŸ˜ŠðŸŒ¹ðŸ¥´ðŸ˜½ðŸ’‹ðŸ˜­ðŸ–¤ðŸ™†ðŸ‘âšªðŸ’Ÿâ˜ƒðŸ™ˆðŸ­ðŸ’»ðŸ¥€ðŸš—ðŸ¤§ðŸðŸ’ŽðŸ’“ðŸ¤ðŸ’„ðŸ’–ðŸ”žâ‰â°ðŸ•ŠðŸŽ§â˜ â™¥ðŸŒ³ðŸ¾ðŸ™‰â­ðŸ’ŠðŸ³ðŸŒŽðŸ™ŠðŸ’¸â¤ðŸ”ªðŸ˜†ðŸŒ¾âœˆðŸ“šðŸ’€ðŸ âœŒðŸƒðŸŒµðŸš¨ðŸ’‚ðŸ¤«ðŸ¤­ðŸ˜—ðŸ˜„ðŸ’ðŸ‘ðŸ™ƒðŸ––ðŸ’žðŸ˜…ðŸŽ…ðŸ„ðŸ†“ðŸ‘‰ðŸ’©ðŸ”ŠðŸ¤·âŒšðŸ‘¸ðŸ˜‡ðŸš®ðŸ’ðŸ‘³ðŸ½ðŸ’˜ðŸ’¿ðŸ’‰ðŸ‘ ðŸŽ¼ðŸŽ¶ðŸŽ¤ðŸ‘—â„ðŸ”ðŸŽµðŸ¤’ðŸ°ðŸ‘“ðŸ„ðŸŒ²ðŸŽ®ðŸ™‚ðŸ“ˆðŸš™ðŸ“ðŸ˜µðŸ—£â—ðŸŒºðŸ™„ðŸ‘„ðŸš˜ðŸ¥ºðŸŒðŸ¡â™¦ðŸ’ðŸŒ±ðŸ‘‘ðŸ‘™â˜‘ðŸ‘¾ðŸ©ðŸ¥¶ðŸ“£ðŸ¼ðŸ¤£â˜¯ðŸ‘µðŸ«âž¡ðŸŽ€ðŸ˜ƒâœ‹ðŸžðŸ™‡ðŸ˜¹ðŸ™ðŸ‘¼ðŸâš«ðŸŽðŸªðŸ”¨ðŸŒ¼ðŸ‘†ðŸ‘€ðŸ˜³ðŸŒðŸ“–ðŸ‘ƒðŸŽ¸ðŸ‘§ðŸ’‡ðŸ”’ðŸ’™ðŸ˜žâ›…ðŸ»ðŸ´ðŸ˜¼ðŸ—¿ðŸ—â™ ðŸ¦âœ”ðŸ¤–â˜®ðŸ¢ðŸŽðŸ’¤ðŸ˜€ðŸºðŸ˜ðŸ˜´ðŸ“ºâ˜¹ðŸ˜²ðŸ‘ðŸŽ­ðŸ’šðŸ†ðŸ‹ðŸ”µðŸðŸ”´ðŸ””ðŸ§ðŸ‘°â˜ŽðŸ†ðŸ¤¡ðŸ ðŸ“²ðŸ™‹ðŸ“ŒðŸ¬âœðŸ”‘ðŸ“±ðŸ’°ðŸ±ðŸ’§ðŸŽ“ðŸ•ðŸ‘ŸðŸ£ðŸ‘«ðŸ‘ðŸ˜¸ðŸ¦ðŸ‘ðŸ†—ðŸŽ¯ðŸ“¢ðŸš¶ðŸ¦…ðŸ§ðŸ’¢ðŸ€ðŸš«ðŸ’‘ðŸŸðŸŒ½ðŸŠðŸŸðŸ’ðŸ’²ðŸðŸ¥ðŸ¸â˜â™£ðŸ‘Šâš“âŒðŸ¯ðŸˆðŸ“°ðŸŒ§ðŸ‘¿ðŸ³ðŸ’·ðŸºðŸ“žðŸ†’ðŸ€ðŸ¤ðŸš²ðŸ”ðŸ‘¹ðŸ™ðŸŒ·ðŸ™ŽðŸ¥ðŸ’µðŸ”ðŸ“¸âš â“ðŸŽ©âœ‚ðŸ¼ðŸ˜‘â¬‡âš¾ðŸŽðŸ’”ðŸ”âš½ðŸ’­ðŸŒðŸ·ðŸâœ–ðŸ‡ðŸ“ðŸŠðŸ™ðŸ‘‹ðŸ¤”ðŸ¥ŠðŸ—½ðŸ‘ðŸ˜ðŸ°ðŸ’ðŸ´â™€ðŸ¦ðŸ“âœðŸ‘‚ðŸ´ðŸ‘‡ðŸ†˜ðŸ˜¡ðŸ‰ðŸ‘©ðŸ’ŒðŸ˜ºâœðŸ¼ðŸ’ðŸ¶ðŸ‘ºðŸ–•ðŸ‘¬ðŸ‰ðŸ»ðŸ¾â¬…â¬â–¶ðŸ‘®ðŸŒâ™‚ðŸ”¸ðŸ‘¶ðŸ®ðŸ‘ªâ›³ðŸðŸŽ¾ðŸ•ðŸ‘´ðŸ¨ðŸŠðŸ”¹Â©ðŸŽ£ðŸ‘¦ðŸ‘£ðŸ‘¨ðŸ‘ˆðŸ’¬â­•ðŸ“¹ðŸ“·"
)


def _lower_clean_dict_keys(dict: MenuItems) -> dict[str, Any]:
    return {str(k).lower().strip(): v for k, v in dict.items()}


def _get_favicon_string(page_icon: PageIcon) -> str:
    

    
    if page_icon == "random":
        return get_random_emoji()

    
    if isinstance(page_icon, str) and is_emoji(page_icon):
        return f"emoji:{page_icon}"

    if isinstance(page_icon, str) and page_icon.startswith(":material"):
        return validate_material_icon(page_icon)

    
    if isinstance(page_icon, Path):
        page_icon = str(page_icon)

    
    try:
        return image_to_url(
            page_icon,
            width=-1,  
            clamp=False,
            channels="RGB",
            output_format="auto",
            image_id="favicon",
        )
    except Exception:
        if isinstance(page_icon, str):
            
            
            
            return page_icon
        raise


@gather_metrics("set_page_config")
def set_page_config(
    page_title: str | None = None,
    page_icon: PageIcon | None = None,
    layout: Layout | None = None,
    initial_sidebar_state: InitialSideBarState | None = None,
    menu_items: MenuItems | None = None,
) -> None:
    

    msg = ForwardProto()

    if page_title is not None:
        msg.page_config_changed.title = page_title

    if page_icon is not None:
        msg.page_config_changed.favicon = _get_favicon_string(page_icon)

    pb_layout: PageConfigProto.Layout.ValueType
    if layout == "centered":
        pb_layout = PageConfigProto.CENTERED
    elif layout == "wide":
        pb_layout = PageConfigProto.WIDE
    elif layout is None:
        
        pb_layout = PageConfigProto.LAYOUT_UNSET
    else:
        
        raise StreamlitInvalidPageLayoutError(layout=layout)

    msg.page_config_changed.layout = pb_layout

    pb_sidebar_state: PageConfigProto.SidebarState.ValueType
    if initial_sidebar_state == "auto":
        pb_sidebar_state = PageConfigProto.AUTO
    elif initial_sidebar_state == "expanded":
        pb_sidebar_state = PageConfigProto.EXPANDED
    elif initial_sidebar_state == "collapsed":
        pb_sidebar_state = PageConfigProto.COLLAPSED
    elif initial_sidebar_state is None:
        
        pb_sidebar_state = PageConfigProto.SIDEBAR_UNSET
    else:
        
        raise StreamlitInvalidSidebarStateError(
            initial_sidebar_state=initial_sidebar_state
        )

    msg.page_config_changed.initial_sidebar_state = pb_sidebar_state

    if menu_items is not None:
        lowercase_menu_items = cast("MenuItems", _lower_clean_dict_keys(menu_items))
        validate_menu_items(lowercase_menu_items)
        menu_items_proto = msg.page_config_changed.menu_items
        set_menu_items_proto(lowercase_menu_items, menu_items_proto)

    ctx = get_script_run_ctx()
    if ctx is None:
        return
    ctx.enqueue(msg)


def get_random_emoji() -> str:
    
    return random.choice(RANDOM_EMOJIS)  


def set_menu_items_proto(
    lowercase_menu_items: MenuItems, menu_items_proto: PageConfigProto.MenuItems
) -> None:
    if GET_HELP_KEY in lowercase_menu_items:
        if lowercase_menu_items[GET_HELP_KEY] is not None:
            menu_items_proto.get_help_url = lowercase_menu_items[GET_HELP_KEY]
        else:
            menu_items_proto.hide_get_help = True

    if REPORT_A_BUG_KEY in lowercase_menu_items:
        if lowercase_menu_items[REPORT_A_BUG_KEY] is not None:
            menu_items_proto.report_a_bug_url = lowercase_menu_items[REPORT_A_BUG_KEY]
        else:
            menu_items_proto.hide_report_a_bug = True

    if ABOUT_KEY in lowercase_menu_items:
        if lowercase_menu_items[ABOUT_KEY] is not None:
            menu_items_proto.about_section_md = dedent(lowercase_menu_items[ABOUT_KEY])
        else:
            
            menu_items_proto.clear_about_md = True


def validate_menu_items(menu_items: MenuItems) -> None:
    for k, v in menu_items.items():
        if not valid_menu_item_key(k):
            raise StreamlitInvalidMenuItemKeyError(key=k)
        if v is not None and (
            not is_url(v, ("http", "https", "mailto")) and k != ABOUT_KEY
        ):
            raise StreamlitInvalidURLError(url=v)


def valid_menu_item_key(key: str) -> TypeGuard[MenuKey]:
    return key in {GET_HELP_KEY, REPORT_A_BUG_KEY, ABOUT_KEY}
