from __future__ import annotations

from typing import (
    TYPE_CHECKING,
    Any,
)

from pandas.core.interchange.dataframe_protocol import (
    Buffer,
    DlpackDeviceType,
)

if TYPE_CHECKING:
    import numpy as np
    import pyarrow as pa


class PandasBuffer(Buffer):
    

    def __init__(self, x: np.ndarray, allow_copy: bool = True) -> None:
        
        if x.strides[0] and not x.strides == (x.dtype.itemsize,):
            
            
            if allow_copy:
                x = x.copy()
            else:
                raise RuntimeError(
                    "Exports cannot be zero-copy in the case "
                    "of a non-contiguous buffer"
                )

        
        
        self._x = x

    @property
    def bufsize(self) -> int:
        
        return self._x.size * self._x.dtype.itemsize

    @property
    def ptr(self) -> int:
        
        return self._x.__array_interface__["data"][0]

    def __dlpack__(self) -> Any:
        
        return self._x.__dlpack__()

    def __dlpack_device__(self) -> tuple[DlpackDeviceType, int | None]:
        
        return (DlpackDeviceType.CPU, None)

    def __repr__(self) -> str:
        return (
            "PandasBuffer("
            + str(
                {
                    "bufsize": self.bufsize,
                    "ptr": self.ptr,
                    "device": self.__dlpack_device__()[0].name,
                }
            )
            + ")"
        )


class PandasBufferPyarrow(Buffer):
    

    def __init__(
        self,
        buffer: pa.Buffer,
        *,
        length: int,
    ) -> None:
        
        self._buffer = buffer
        self._length = length

    @property
    def bufsize(self) -> int:
        
        return self._buffer.size

    @property
    def ptr(self) -> int:
        
        return self._buffer.address

    def __dlpack__(self) -> Any:
        
        raise NotImplementedError()

    def __dlpack_device__(self) -> tuple[DlpackDeviceType, int | None]:
        
        return (DlpackDeviceType.CPU, None)

    def __repr__(self) -> str:
        return (
            "PandasBuffer[pyarrow]("
            + str(
                {
                    "bufsize": self.bufsize,
                    "ptr": self.ptr,
                    "device": "CPU",
                }
            )
            + ")"
        )
