from typing import Literal, Optional, Type, TypedDict

from langchain_core.utils.json_schema import dereference_refs
from pydantic import BaseModel


class FunctionDescription(TypedDict):
    

    name: str
    
    description: str
    
    parameters: dict
    


class ToolDescription(TypedDict):
    

    type: Literal["function"]
    function: FunctionDescription


def convert_pydantic_to_ernie_function(
    model: Type[BaseModel],
    *,
    name: Optional[str] = None,
    description: Optional[str] = None,
) -> FunctionDescription:
    
    schema = dereference_refs(model.schema())
    schema.pop("definitions", None)
    return {
        "name": name or schema["title"],
        "description": description or schema["description"],
        "parameters": schema,
    }


def convert_pydantic_to_ernie_tool(
    model: Type[BaseModel],
    *,
    name: Optional[str] = None,
    description: Optional[str] = None,
) -> ToolDescription:
    
    function = convert_pydantic_to_ernie_function(
        model, name=name, description=description
    )
    return {"type": "function", "function": function}
