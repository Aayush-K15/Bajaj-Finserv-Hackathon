

import json
from typing import Any, Dict, Optional

from pydantic import BaseModel, ConfigDict, model_validator


class LambdaWrapper(BaseModel):
    

    lambda_client: Any = None  
    
    function_name: Optional[str] = None
    
    awslambda_tool_name: Optional[str] = None
    
    awslambda_tool_description: Optional[str] = None
    

    model_config = ConfigDict(
        extra="forbid",
    )

    @model_validator(mode="before")
    @classmethod
    def validate_environment(cls, values: Dict) -> Any:
        

        try:
            import boto3

        except ImportError:
            raise ImportError(
                "boto3 is not installed. Please install it with `pip install boto3`"
            )

        values["lambda_client"] = boto3.client("lambda")
        return values

    def run(self, query: str) -> str:
        
        res = self.lambda_client.invoke(
            FunctionName=self.function_name,
            InvocationType="RequestResponse",
            Payload=json.dumps({"body": query}),
        )

        try:
            payload_stream = res["Payload"]
            payload_string = payload_stream.read().decode("utf-8")
            answer = json.loads(payload_string)["body"]

        except StopIteration:
            return "Failed to parse response from Lambda"

        if answer is None or answer == "":
            
            return "Request failed."
        else:
            return f"Result: {answer}"
