

from __future__ import annotations

import hashlib
from typing import TYPE_CHECKING

from docx.image.image import Image
from docx.opc.part import Part
from docx.shared import Emu, Inches

if TYPE_CHECKING:
    from docx.opc.package import OpcPackage
    from docx.opc.packuri import PackURI


class ImagePart(Part):
    

    def __init__(
        self, partname: PackURI, content_type: str, blob: bytes, image: Image | None = None
    ):
        super(ImagePart, self).__init__(partname, content_type, blob)
        self._image = image

    @property
    def default_cx(self):
        
        px_width = self.image.px_width
        horz_dpi = self.image.horz_dpi
        width_in_inches = px_width / horz_dpi
        return Inches(width_in_inches)

    @property
    def default_cy(self):
        
        px_height = self.image.px_height
        horz_dpi = self.image.horz_dpi
        height_in_emu = int(round(914400 * px_height / horz_dpi))
        return Emu(height_in_emu)

    @property
    def filename(self):
        
        if self._image is not None:
            return self._image.filename
        return "image.%s" % self.partname.ext

    @classmethod
    def from_image(cls, image: Image, partname: PackURI):
        
        return ImagePart(partname, image.content_type, image.blob, image)

    @property
    def image(self) -> Image:
        if self._image is None:
            self._image = Image.from_blob(self.blob)
        return self._image

    @classmethod
    def load(cls, partname: PackURI, content_type: str, blob: bytes, package: OpcPackage):
        
        return cls(partname, content_type, blob)

    @property
    def sha1(self):
        
        return hashlib.sha1(self.blob).hexdigest()
