

import numpy as np
import pytest

from shapely.geometry import MultiPoint
from shapely.ops import voronoi_diagram
from shapely.wkt import loads as load_wkt


def test_no_regions():
    mp = MultiPoint(points=[(0.5, 0.5)])
    with np.errstate(invalid="ignore"):
        regions = voronoi_diagram(mp)

    assert len(regions.geoms) == 0


def test_two_regions():
    mp = MultiPoint(points=[(0.5, 0.5), (1.0, 1.0)])
    regions = voronoi_diagram(mp)

    assert len(regions.geoms) == 2


def test_edges():
    mp = MultiPoint(points=[(0.5, 0.5), (1.0, 1.0)])
    regions = voronoi_diagram(mp, edges=True)

    assert len(regions.geoms) == 1
    
    assert all(r.geom_type.endswith("LineString") for r in regions.geoms)


def test_smaller_envelope():
    mp = MultiPoint(points=[(0.5, 0.5), (1.0, 1.0)])
    poly = load_wkt("POLYGON ((0 0, 0.5 0, 0.5 0.5, 0 0.5, 0 0))")

    regions = voronoi_diagram(mp, envelope=poly)

    assert len(regions.geoms) == 2
    assert sum(r.area for r in regions.geoms) > poly.area


def test_larger_envelope():
    
    mp = MultiPoint(points=[(0.5, 0.5), (1.0, 1.0)])
    poly = load_wkt("POLYGON ((0 0, 2 0, 2 2, 0 2, 0 0))")

    regions = voronoi_diagram(mp, envelope=poly)

    assert len(regions.geoms) == 2
    assert sum(r.area for r in regions.geoms) == poly.area


def test_from_polygon():
    poly = load_wkt("POLYGON ((0 0, 1 0, 1 1, 0 1, 0 0))")
    regions = voronoi_diagram(poly)

    assert len(regions.geoms) == 4


def test_from_polygon_with_enough_tolerance():
    poly = load_wkt("POLYGON ((0 0, 0.5 0, 0.5 0.5, 0 0.5, 0 0))")
    regions = voronoi_diagram(poly, tolerance=1.0)

    assert len(regions.geoms) == 2


def test_from_polygon_without_enough_tolerance():
    poly = load_wkt("POLYGON ((0 0, 0.5 0, 0.5 0.5, 0 0.5, 0 0))")
    with pytest.raises(ValueError) as exc:
        voronoi_diagram(poly, tolerance=0.6)

    assert "Could not create Voronoi Diagram with the specified inputs" in str(
        exc.value
    )
    assert "Try running again with default tolerance value." in str(exc.value)


def test_from_polygon_without_floating_point_coordinates():
    poly = load_wkt("POLYGON ((0 0, 1 0, 1 1, 0 1, 0 0))")
    with pytest.raises(ValueError) as exc:
        voronoi_diagram(poly, tolerance=0.1)

    assert "Could not create Voronoi Diagram with the specified inputs" in str(
        exc.value
    )
    assert "Try running again with default tolerance value." in str(exc.value)


def test_from_multipoint_without_floating_point_coordinates():
    
    mp = load_wkt("MULTIPOINT (0 0, 1 0, 1 1, 0 1)")

    with pytest.raises(ValueError) as exc:
        voronoi_diagram(mp, tolerance=0.1)

    assert "Could not create Voronoi Diagram with the specified inputs" in str(
        exc.value
    )
    assert "Try running again with default tolerance value." in str(exc.value)


def test_from_multipoint_with_tolerace_without_floating_point_coordinates():
    
    mp = load_wkt("MULTIPOINT (0 0, 1 0, 1 2, 0 1)")
    with pytest.raises(ValueError) as exc:
        voronoi_diagram(mp, tolerance=0.1)

    assert "Could not create Voronoi Diagram with the specified inputs" in str(
        exc.value
    )
    assert "Try running again with default tolerance value." in str(exc.value)


def test_from_multipoint_without_tolerace_without_floating_point_coordinates():
    
    mp = load_wkt("MULTIPOINT (0 0, 1 0, 1 2, 0 1)")
    regions = voronoi_diagram(mp)
    assert len(regions.geoms) == 4
