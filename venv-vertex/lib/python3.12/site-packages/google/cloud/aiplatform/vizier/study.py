














import copy
from typing import Optional, Collection, Type, TypeVar

from google.api_core import exceptions
from google.auth import credentials as auth_credentials
from google.cloud.aiplatform import base
from google.cloud.aiplatform import utils
from google.cloud.aiplatform import initializer
from google.cloud.aiplatform.vizier import client_abc
from google.cloud.aiplatform.vizier import pyvizier as vz
from google.cloud.aiplatform.vizier.trial import Trial


from google.cloud.aiplatform.compat.types import study as gca_study


_T = TypeVar("_T")
_LOGGER = base.Logger(__name__)


class Study(base.VertexAiResourceNounWithFutureManager, client_abc.StudyInterface):
    

    client_class = utils.VizierClientWithOverride

    _resource_noun = "study"
    _getter_method = "get_study"
    _list_method = "list_studies"
    _delete_method = "delete_study"
    _parse_resource_name_method = "parse_study_path"
    _format_resource_name_method = "study_path"

    def __init__(
        self,
        study_id: str,
        project: Optional[str] = None,
        location: Optional[str] = None,
        credentials: Optional[auth_credentials.Credentials] = None,
    ):
        
        base.VertexAiResourceNounWithFutureManager.__init__(
            self,
            project=project,
            location=location,
            credentials=credentials,
            resource_name=study_id,
        )
        self._gca_resource = self._get_gca_resource(resource_name=study_id)

    @classmethod
    @base.optional_sync()
    def create_or_load(
        cls,
        display_name: str,
        problem: vz.ProblemStatement,
        project: Optional[str] = None,
        location: Optional[str] = None,
        credentials: Optional[auth_credentials.Credentials] = None,
    ) -> client_abc.StudyInterface:
        
        project = initializer.global_config.project if not project else project
        location = initializer.global_config.location if not location else location
        credentials = (
            initializer.global_config.credentials if not credentials else credentials
        )

        api_client = cls._instantiate_client(
            location=location,
            credentials=credentials,
        )
        study = gca_study.Study(
            display_name=display_name, study_spec=problem.to_proto()
        )

        try:
            study = api_client.create_study(
                parent=initializer.global_config.common_location_path(
                    project,
                    location,
                ),
                study=study,
            )
        except exceptions.AlreadyExists:
            _LOGGER.info("The study is already created. Using existing study.")
            study = api_client.lookup_study(
                request={
                    "parent": initializer.global_config.common_location_path(
                        project,
                        location,
                    ),
                    "display_name": display_name,
                },
            )

        return Study(study.name)

    def get_trial(self, uid: int) -> client_abc.TrialInterface:
        
        study_path_components = self._parse_resource_name(self.resource_name)
        return Trial(
            Trial._format_resource_name(
                project=study_path_components["project"],
                location=study_path_components["location"],
                study=study_path_components["study"],
                trial=uid,
            ),
            credentials=self.credentials,
        )

    def trials(
        self, trial_filter: Optional[vz.TrialFilter] = None
    ) -> Collection[client_abc.TrialInterface]:
        
        list_trials_request = {"parent": self.resource_name}
        trials_response = self.api_client.list_trials(request=list_trials_request)
        return [
            Trial._construct_sdk_resource_from_gapic(
                trial,
                project=self.project,
                location=self.location,
                credentials=self.credentials,
            )
            for trial in trials_response.trials
        ]

    def optimal_trials(self) -> Collection[client_abc.TrialInterface]:
        
        list_optimal_trials_request = {"parent": self.resource_name}
        optimal_trials_response = self.api_client.list_optimal_trials(
            request=list_optimal_trials_request
        )
        return [
            Trial._construct_sdk_resource_from_gapic(
                trial,
                project=self.project,
                location=self.location,
                credentials=self.credentials,
            )
            for trial in optimal_trials_response.optimal_trials
        ]

    def materialize_study_config(self) -> vz.StudyConfig:
        
        study = self.api_client.get_study(
            name=self.resource_name, credentials=self.credentials
        )
        return copy.deepcopy(vz.StudyConfig.from_proto(study.study_spec))

    @classmethod
    def from_uid(
        cls: Type[_T],
        uid: str,
        project: Optional[str] = None,
        location: Optional[str] = None,
        credentials: Optional[auth_credentials.Credentials] = None,
    ) -> _T:
        
        project = initializer.global_config.project if not project else project
        location = initializer.global_config.location if not location else location
        credentials = (
            initializer.global_config.credentials if not credentials else credentials
        )

        return Study(
            study_id=uid, project=project, location=location, credentials=credentials
        )

    def suggest(
        self, *, count: Optional[int] = None, worker: str = ""
    ) -> Collection[client_abc.TrialInterface]:
        
        suggest_trials_lro = self.api_client.suggest_trials(
            request={
                "parent": self.resource_name,
                "suggestion_count": count,
                "client_id": worker,
            },
        )
        _LOGGER.log_action_started_against_resource_with_lro(
            "Suggest", "study", self.__class__, suggest_trials_lro
        )
        _LOGGER.info(self.client_class.get_gapic_client_class())
        trials = suggest_trials_lro.result()
        _LOGGER.log_action_completed_against_resource("study", "suggested", self)
        return [
            Trial._construct_sdk_resource_from_gapic(
                trial,
                project=self.project,
                location=self.location,
                credentials=self.credentials,
            )
            for trial in trials.trials
        ]

    def delete(self) -> None:
        
        self.api_client.delete_study(name=self.resource_name)
