__all__ = [
    'Task',
]


import datetime
import functools
import json
import logging

from typing import Optional

from .. import constants
from ..enums import (
        TaskAcceptance, TaskHistory, TaskMode, TaskMultipleRecipients,
        TaskOwnership, TaskState, TaskStatus
    )
from .message_base import MessageBase
from ..structures.recurrence_pattern import RecurrencePattern
from ..utils import unsignedToSignedInt


logger = logging.getLogger(__name__)
logger.addHandler(logging.NullHandler())


class Task(MessageBase):
    

    def getJson(self) -> str:
        status = {
            TaskStatus.NOT_STARTED: 'Not Started',
            TaskStatus.IN_PROGRESS: 'In Progress',
            TaskStatus.COMPLETE: 'Completed',
            TaskStatus.WAITING_ON_OTHER: 'Waiting on someone else',
            TaskStatus.DEFERRED: 'Deferred',
            None: None,
        }[self.taskStatus]

        return json.dumps({
            'subject': self.subject,
            'status': status,
            'percentComplete': f'{self.percentComplete*100:.0f}%',
            'dateCompleted': self.taskDateCompleted.__format__(self.dateFormat) if self.taskDateCompleted else None,
            'totalWork': f'{self.taskEstimatedEffort or 0} minutes',
            'actualWork': f'{self.taskActualEffort or 0} minutes',
            'owner': self.taskOwner,
            'importance': self.importanceString,
        })

    @property
    def headerFormatProperties(self) -> constants.HEADER_FORMAT_TYPE:
        status = {
            TaskStatus.NOT_STARTED: 'Not Started',
            TaskStatus.IN_PROGRESS: 'In Progress',
            TaskStatus.COMPLETE: 'Completed',
            TaskStatus.WAITING_ON_OTHER: 'Waiting on someone else',
            TaskStatus.DEFERRED: 'Deferred',
            None: None,
        }[self.taskStatus]

        return {
            '-basic info-': {
                'Subject': self.subject,
            },
            '-status-': {
                'Status': status,
                'Percent Complete': f'{self.percentComplete*100:.0f}%',
                'Date Completed': self.taskDateCompleted.__format__(self.dateFormat) if self.taskDateCompleted else None,
            },
            '-work-': {
                'Total Work': f'{self.taskEstimatedEffort or 0} minutes',
                'Actual Work': f'{self.taskActualEffort or 0} minutes',
            },
            '-owner-': {
                'Owner': self.taskOwner,
            },
            '-importance-': {
                'Importance': self.importanceString,
            },
        }

    @functools.cached_property
    def percentComplete(self) -> float:
        
        return self.getNamedProp('8102', constants.ps.PSETID_TASK, 0.0)

    @functools.cached_property
    def taskAcceptanceState(self) -> Optional[TaskAcceptance]:
        
        return self.getNamedAs('812A', constants.ps.PSETID_TASK, TaskAcceptance)

    @functools.cached_property
    def taskAccepted(self) -> bool:
        
        return bool(self.getNamedProp('8108', constants.ps.PSETID_TASK))

    @functools.cached_property
    def taskActualEffort(self) -> Optional[int]:
        
        return self.getNamedProp('8110', constants.ps.PSETID_TASK)

    @functools.cached_property
    def taskAssigner(self) -> Optional[str]:
        
        return self.getNamedProp('8121', constants.ps.PSETID_TASK)

    @functools.cached_property
    def taskAssigners(self) -> Optional[bytes]:
        
        return self.getNamedProp('8117', constants.ps.PSETID_TASK)

    @functools.cached_property
    def taskComplete(self) -> bool:
        
        return bool(self.getNamedProp('811C', constants.ps.PSETID_TASK))

    @functools.cached_property
    def taskCustomFlags(self) -> Optional[int]:
        
        return self.getNamedProp('8139', constants.ps.PSETID_TASK)

    @functools.cached_property
    def taskDateCompleted(self) -> Optional[datetime.datetime]:
        
        return self.getNamedProp('810F', constants.ps.PSETID_TASK)

    @functools.cached_property
    def taskDeadOccurrence(self) -> bool:
        
        return bool(self.getNamedProp('8109', constants.ps.PSETID_TASK))

    @functools.cached_property
    def taskDueDate(self) -> Optional[datetime.datetime]:
        
        return self.getNamedProp('8105', constants.ps.PSETID_TASK)

    @functools.cached_property
    def taskEstimatedEffort(self) -> Optional[int]:
        
        return self.getNamedProp('8111', constants.ps.PSETID_TASK)

    @functools.cached_property
    def taskFCreator(self) -> bool:
        
        return bool(self.getNamedProp('811E', constants.ps.PSETID_TASK))

    @functools.cached_property
    def taskFFixOffline(self) -> bool:
        
        return bool(self.getNamedProp('812C', constants.ps.PSETID_TASK))

    @functools.cached_property
    def taskFRecurring(self) -> bool:
        
        return bool(self.getNamedProp('8126', constants.ps.PSETID_TASK))

    @functools.cached_property
    def taskGlobalID(self) -> Optional[bytes]:
        
        return self.getNamedProp('8519', constants.ps.PSETID_COMMON)

    @functools.cached_property
    def taskHistory(self) -> Optional[TaskHistory]:
        
        return self.getNamedAs('811A', constants.ps.PSETID_TASK, TaskHistory)

    @functools.cached_property
    def taskLastDelegate(self) -> Optional[str]:
        
        return self.getNamedProp('8125', constants.ps.PSETID_TASK)

    @functools.cached_property
    def taskLastUpdate(self) -> Optional[datetime.datetime]:
        
        return self.getNamedProp('8115', constants.ps.PSETID_TASK)

    @functools.cached_property
    def taskLastUser(self) -> Optional[str]:
        
        return self.getNamedProp('8122', constants.ps.PSETID_TASK)

    @functools.cached_property
    def taskMode(self) -> Optional[TaskMode]:
        
        return self.getNamedAs('8518', constants.ps.PSETID_COMMON, TaskMode)

    @functools.cached_property
    def taskMultipleRecipients(self) -> Optional[TaskMultipleRecipients]:
        
        return self.getNamedAs('8120', constants.ps.PSETID_TASK, TaskMultipleRecipients)

    @functools.cached_property
    def taskNoCompute(self) -> Optional[bool]:
        
        return self.getNamedProp('8124', constants.ps.PSETID_TASK)

    @functools.cached_property
    def taskOrdinal(self) -> Optional[int]:
        
        return self.getNamedAs('8123', constants.ps.PSETID_TASK, unsignedToSignedInt)

    @functools.cached_property
    def taskOwner(self) -> Optional[str]:
        
        return self.getNamedProp('811F', constants.ps.PSETID_TASK)

    @functools.cached_property
    def taskOwnership(self) -> Optional[TaskOwnership]:
        
        return self.getNamedAs('8129', constants.ps.PSETID_TASK, TaskOwnership)

    @functools.cached_property
    def taskRecurrence(self) -> Optional[RecurrencePattern]:
        
        return self.getNamedAs('8116', constants.ps.PSETID_TASK, RecurrencePattern)

    @functools.cached_property
    def taskResetReminder(self) -> bool:
        
        return bool(self.getNamedProp('8107', constants.ps.PSETID_TASK))

    @functools.cached_property
    def taskRole(self) -> Optional[str]:
        
        return self.getNamedProp('8127', constants.ps.PSETID_TASK)

    @functools.cached_property
    def taskStartDate(self) -> Optional[datetime.datetime]:
        
        return self.getNamedProp('8104', constants.ps.PSETID_TASK)

    @functools.cached_property
    def taskState(self) -> Optional[TaskState]:
        
        return self.getNamedAs('8113', constants.ps.PSETID_TASK, TaskState)

    @functools.cached_property
    def taskStatus(self) -> Optional[TaskStatus]:
        
        return self.getNamedAs('8101', constants.ps.PSETID_TASK, TaskStatus)

    @functools.cached_property
    def taskStatusOnComplete(self) -> bool:
        
        return bool(self.getNamedProp('8119', constants.ps.PSETID_TASK))

    @functools.cached_property
    def taskUpdates(self) -> bool:
        
        return bool(self.getNamedProp('811B', constants.ps.PSETID_TASK))

    @functools.cached_property
    def taskVersion(self) -> Optional[int]:
        
        return self.getNamedProp('8112', constants.ps.PSETID_TASK)

    @functools.cached_property
    def teamTask(self) -> Optional[bool]:
        
        return self.getNamedProp('8103', constants.ps.PSETID_TASK)
