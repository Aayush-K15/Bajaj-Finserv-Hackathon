


__all__ = [
    'FolderID',
    'GlobalObjectID',
    'MessageID',
    'ServerID',
]


import datetime

from .. import constants
from ._helpers import BytesReader
from ..utils import filetimeToDatetime


class FolderID:
    

    __SIZE__: int = 16

    def __init__(self, data: bytes):
        self.__rawData = data
        self.__replicaID = constants.st.ST_LE_UI16.unpack(data[:2])[0]
        
        self.__globalCounter = constants.st.ST_LE_UI64.unpack(data[2:8] + b'\x00\x00')[0]

    def __bytes__(self) -> bytes:
        return self.toBytes()

    def toBytes(self) -> bytes:
        return self.__rawData

    @property
    def globalCounter(self) -> int:
        
        return self.__globalCounter

    @property
    def replicaID(self) -> int:
        
        return self.__replicaID



class GlobalObjectID:
    

    def __init__(self, data: bytes):
        self.__rawData = data
        reader = BytesReader(data)
        expectedBytes = b'\x04\x00\x00\x00\x82\x00\xE0\x00\x74\xC5\xB7\x10\x1A\x82\xE0\x08'
        errorMsg = 'Byte Array ID did not match for GlobalObjectID (got {actual}).'
        self.__byteArrayID = reader.assertRead(expectedBytes, errorMsg)
        self.__yh = reader.read(1)
        self.__yl = reader.read(1)
        self.__year = constants.st.ST_BE_UI16.unpack(self.__yh + self.__yl)[0]
        self.__month = reader.readUnsignedByte()
        self.__day = reader.readUnsignedByte()
        self.__creationTime = filetimeToDatetime(reader.readUnsignedLong())
        reader.assertNull(8, 'Reserved was not set to null.')
        size = reader.readUnsignedInt()
        self.__data = reader.read(size)

    def __bytes__(self) -> bytes:
        return self.toBytes()

    def toBytes(self) -> bytes:
        return self.__rawData

    @property
    def byteArrayID(self) -> bytes:
        
        return self.__byteArrayID

    @property
    def creationTime(self) -> datetime.datetime:
        
        return self.__creationTime

    @property
    def data(self) -> bytes:
        
        return self.__data

    @property
    def day(self) -> int:
        
        return self.__day

    @property
    def month(self) -> int:
        
        return self.__month

    @property
    def year(self) -> int:
        
        return self.__year



class MessageID:
    

    __SIZE__: int = 8

    def __init__(self, data: bytes):
        self.__rawData = data
        self.__replicaID = constants.st.ST_LE_UI16.unpack(data[:2])[0]
        
        self.__globalCounter = constants.st.ST_LE_UI64.unpack(data[2:8] + b'\x00\x00')[0]

    def __bytes__(self) -> bytes:
        return self.toBytes()

    def toBytes(self) -> bytes:
        return self.__rawData

    @property
    def globalCounter(self) -> int:
        
        return self.__globalCounter

    @property
    def isFolder(self) -> bool:
        
        return self.__globalCounter == 0 and self.__replicaID == 0

    @property
    def replicaID(self) -> int:
        
        return self.__replicaID



class ServerID:
    
    def __init__(self, data: bytes):
        
        
        
        if data[0] != 1:
            raise TypeError('Not a standard ServerID.')
        self.__rawData = data
        self.__folderID = FolderID(data[1:9])
        self.__messageID = MessageID(data[9:17])
        self.__instance = constants.st.ST_LE_UI32.unpack(data[17:21])[0]

    def __bytes__(self) -> bytes:
        return self.toBytes()

    def toBytes(self) -> bytes:
        return self.__rawData

    @property
    def folderID(self) -> FolderID:
        
        return self.__folderID

    @property
    def instance(self) -> int:
        
        return self.__instance

    @property
    def messageID(self) -> MessageID:
        
        return self.__messageID
