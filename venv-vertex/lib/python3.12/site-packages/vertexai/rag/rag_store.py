

















import re
from typing import List, Optional, Union

from google.cloud import aiplatform_v1beta1
from google.cloud.aiplatform import initializer
from google.cloud.aiplatform_v1beta1.types import tool as gapic_tool_types
from vertexai import generative_models
from vertexai.rag.utils import _gapic_utils
from vertexai.rag.utils import resources


class Retrieval(generative_models.grounding.Retrieval):
    

    def __init__(
        self,
        source: Union["VertexRagStore"],
        disable_attribution: Optional[bool] = False,
    ):
        self._raw_retrieval = gapic_tool_types.Retrieval(
            vertex_rag_store=source._raw_vertex_rag_store,
            disable_attribution=disable_attribution,
        )


class VertexRagStore:
    

    def __init__(
        self,
        rag_resources: Optional[List[resources.RagResource]] = None,
        rag_retrieval_config: Optional[resources.RagRetrievalConfig] = None,
    ):
        

        if rag_resources:
            if len(rag_resources) > 1:
                raise ValueError("Currently only support 1 RagResource.")
            name = rag_resources[0].rag_corpus
        else:
            raise ValueError("rag_resources must be specified.")

        data_client = _gapic_utils.create_rag_data_service_client()
        if data_client.parse_rag_corpus_path(name):
            rag_corpus_name = name
        elif re.match("^{}$".format(_gapic_utils._VALID_RESOURCE_NAME_REGEX), name):
            parent = initializer.global_config.common_location_path()
            rag_corpus_name = parent + "/ragCorpora/" + name
        else:
            raise ValueError(
                f"Invalid RagCorpus name: {name}. Proper format should be:"
                " projects/{project}/locations/{location}/ragCorpora/{rag_corpus_id}"
            )

        
        api_retrieval_config = aiplatform_v1beta1.RagRetrievalConfig()
        
        if rag_retrieval_config:
            api_retrieval_config.top_k = rag_retrieval_config.top_k
            
            if rag_retrieval_config.filter:
                
                
                if (
                    rag_retrieval_config.filter
                    and rag_retrieval_config.filter.vector_distance_threshold
                    and rag_retrieval_config.filter.vector_similarity_threshold
                ):
                    raise ValueError(
                        "Only one of vector_distance_threshold or"
                        " vector_similarity_threshold can be specified at a time"
                        " in rag_retrieval_config."
                    )
                api_retrieval_config.filter.vector_distance_threshold = (
                    rag_retrieval_config.filter.vector_distance_threshold
                )
                api_retrieval_config.filter.vector_similarity_threshold = (
                    rag_retrieval_config.filter.vector_similarity_threshold
                )
            
            if (
                rag_retrieval_config.ranking
                and rag_retrieval_config.ranking.rank_service
                and rag_retrieval_config.ranking.rank_service.model_name
                and rag_retrieval_config.ranking.llm_ranker
                and rag_retrieval_config.ranking.llm_ranker.model_name
            ):
                raise ValueError(
                    "Only one of rank_service or llm_ranker can be specified"
                    " at a time in rag_retrieval_config."
                )
            
            if (
                rag_retrieval_config.ranking
                and rag_retrieval_config.ranking.rank_service
            ):
                api_retrieval_config.ranking.rank_service.model_name = (
                    rag_retrieval_config.ranking.rank_service.model_name
                )
            
            if rag_retrieval_config.ranking and rag_retrieval_config.ranking.llm_ranker:
                api_retrieval_config.ranking.llm_ranker.model_name = (
                    rag_retrieval_config.ranking.llm_ranker.model_name
                )

        gapic_rag_resource = gapic_tool_types.VertexRagStore.RagResource(
            rag_corpus=rag_corpus_name,
            rag_file_ids=rag_resources[0].rag_file_ids,
        )
        self._raw_vertex_rag_store = gapic_tool_types.VertexRagStore(
            rag_resources=[gapic_rag_resource],
            rag_retrieval_config=api_retrieval_config,
        )
